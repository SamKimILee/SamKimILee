<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>JOURNIVERSE | DIARY LIST</title>

    <!-- ✅ TUI Calendar CSS -->
    <link rel="stylesheet" href="https://uicdn.toast.com/tui-calendar/latest/tui-calendar.min.css">
    <link rel="stylesheet" href="/css/diary/diary-datelist.css">

    <!-- ✅ 필수 JS 라이브러리 -->
    <script src="https://uicdn.toast.com/tui.code-snippet/latest/tui-code-snippet.min.js"></script>
    <script src="https://uicdn.toast.com/tui-calendar/latest/tui-calendar.min.js"></script>
</head>

<body>    
    <div class="container">
        <!-- 📌 상단 연도 선택 -->
        <h2><span th:text="${nickname}"></span> 의 
            <select id="yearSelect">
                <option th:each="y : ${#numbers.sequence(2020, 2030)}"
                        th:value="${y}" th:text="${y} + '년'"
                        th:selected="${y == year}"></option>
            </select> Journal
        </h2>

        <div class="content">
            <!-- 📌 캘린더 컨테이너 -->
            <div class="calendar-wrapper">
                <select id="monthSelect">
                    <option th:each="m : ${#numbers.sequence(1, 12)}"
                            th:value="${m}" th:text="${m} + '월'"
                            th:selected="${m == month}"></option>
                </select>
                <div id="calendar"></div>
            </div>

            <!-- 📌 노트 스타일 일기장 -->
            <div class="diary-book">
                <div class="diary-header">
                    <h3 id="diary-title">행복한 오늘!</h3>
                    <p id="diary-date">DATE: <span></span></p>
                </div>
                <div class="diary-content">
                    <p id="diary-text">선택한 일기의 내용이 여기에 표시됩니다.</p>
                </div>
                <div class="diary-footer">
                    <button class="edit-btn" id="editDiaryBtn">수정</button>
                    <button class="delete-btn" id="deleteDiaryBtn">삭제</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const yearSelect = document.getElementById("yearSelect");
            const monthSelect = document.getElementById("monthSelect");
            let currentYear = parseInt(yearSelect.value);
            let currentMonth = parseInt(monthSelect.value);
            let selectedDiaryId = null;

            // ✅ TUI 캘린더 초기화
            let calendar = new tui.Calendar("#calendar", {
                defaultView: "month",
                useCreationPopup: false,
                useDetailPopup: false,
            });

            // 📌 선택된 연/월 유지하면서 데이터 로드
            function loadDiaryData(year, month) {
                fetch(`/diary/list?year=${year}&month=${month}`)
                    .then(response => response.json())
                    .then(data => {
                        calendar.clear();
                        data.forEach(diary => {
                            calendar.createSchedules([{
                                id: diary.diaryId,
                                calendarId: "1",
                                title: diary.diaryTitle,
                                category: "allday",
                                start: diary.diaryDate,
                                bgColor: getEmotionColor(diary.diaryEmotion),
                                borderColor: getEmotionColor(diary.diaryEmotion),
                            }]);
                        });
                    })
                    .catch(error => console.error("일기 데이터를 불러오지 못함:", error));
            }

            // 📌 감정에 따른 배경 색상
            function getEmotionColor(emotion) {
                const colorMap = {
                    "기쁨": "#FFD700",
                    "슬픔": "#4682B4",
                    "분노": "#FF6347",
                    "당황": "#8A2BE2",
                    "불안": "#20B2AA",
                    "중립": "#A9A9A9"
                };
                return colorMap[emotion] || "#D3D3D3";
            }

            // 📌 캘린더에서 특정 날짜 클릭 시 일기 로드
            calendar.on("clickSchedule", function(event) {
                selectedDiaryId = event.schedule.id;
                fetch(`/diary/${selectedDiaryId}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById("diary-title").innerText = data.diaryTitle;
                        document.getElementById("diary-date").innerText = `DATE: ${data.diaryDate}`;
                        document.getElementById("diary-text").innerText = data.diaryContent || "내용 없음";
                    })
                    .catch(error => console.error("일기 데이터를 불러오지 못함:", error));
            });

            // 📌 수정 버튼 클릭 시 해당 일기 수정 페이지로 이동
            document.getElementById("editDiaryBtn").addEventListener("click", function() {
                if (selectedDiaryId) {
                    window.location.href = `/diary/update?diaryId=${selectedDiaryId}`;
                }
            });

            // 📌 삭제 버튼 클릭 시 일기 삭제
            document.getElementById("deleteDiaryBtn").addEventListener("click", function() {
                if (selectedDiaryId && confirm("정말로 삭제하시겠습니까?")) {
                    window.location.href = `/diary/delete?diaryId=${selectedDiaryId}`;
                }
            });

            // 📌 연도/월 변경 시 데이터 다시 로드
            function updateCalendar() {
                currentYear = parseInt(yearSelect.value);
                currentMonth = parseInt(monthSelect.value);
                calendar.setDate(new Date(currentYear, currentMonth - 1, 1));
                loadDiaryData(currentYear, currentMonth);
            }

            yearSelect.addEventListener("change", updateCalendar);
            monthSelect.addEventListener("change", updateCalendar);

            // ✅ 초기 데이터 로드
            loadDiaryData(currentYear, currentMonth);
            calendar.render();
        });
    </script>
</body>
</html>
